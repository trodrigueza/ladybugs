{% extends 'base.html' %}

{% block title %}Nutrición — GluteOS{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto p-6">
  <header class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
    <div>
      <h1 class="text-3xl font-black leading-tight">Planes Nutricionales</h1>
      <p class="text-sm text-gray-500 mt-1">
        Asigna rápidamente un plan de alimentación a cada socio. Hoy es {{ dia_actual_nombre }}.
      </p>
    </div>
    <div class="text-sm text-gray-500">
      Selecciona una plantilla y ajusta el objetivo calórico antes de asignar.
    </div>
  </header>

  {% if messages %}
  <div class="space-y-2 mb-6">
    {% for message in messages %}
      <div class="px-4 py-3 rounded-lg text-sm {% if message.tags == 'success' %}bg-green-50 text-green-700 border border-green-200{% elif message.tags == 'error' %}bg-red-50 text-red-700 border border-red-200{% else %}bg-blue-50 text-blue-700 border border-blue-200{% endif %}">
        {{ message }}
      </div>
    {% endfor %}
  </div>
  {% endif %}

  <section class="mb-10">
    <div class="rounded-2xl border border-border-light dark:border-border-dark bg-white dark:bg-card-dark shadow-sm">
      <div class="px-6 py-4 border-b border-border-light dark:border-border-dark flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
        <div>
          <p class="text-xs uppercase tracking-wide text-gray-400">Plantillas</p>
          <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Repositorio de planes personalizados</h2>
        </div>
        <form method="post" action="{% url 'entrenador_crear_plantilla' %}" class="flex flex-col sm:flex-row gap-2">
          {% csrf_token %}
          <input type="text" name="nombre" placeholder="Nombre de plantilla" class="rounded-lg border border-gray-300 dark:border-border-dark bg-white dark:bg-background-dark px-3 py-2 text-sm" required />
          <input type="number" name="objetivo_calorico" placeholder="kcal/día" class="rounded-lg border border-gray-300 dark:border-border-dark bg-white dark:bg-background-dark px-3 py-2 text-sm w-28" min="1200" max="4500" step="50" />
          <button type="submit" class="inline-flex items-center justify-center gap-2 rounded-lg bg-primary text-white px-4 py-2 text-sm font-semibold hover:bg-primary/90">
            <span class="material-symbols-outlined text-base">add</span>
            Crear plantilla
          </button>
        </form>
      </div>
      <div class="p-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        {% for plantilla in plantillas_db %}
        <article class="rounded-xl border border-border-light dark:border-border-dark p-4 bg-white dark:bg-card-dark shadow-sm flex flex-col gap-3">
          <div>
            <p class="text-sm font-semibold text-gray-900 dark:text-white">{{ plantilla.Nombre|default:"Plantilla sin nombre" }}</p>
            <p class="text-xs text-gray-500">{{ plantilla.ObjetivoCaloricoDiario|default:"-" }} kcal/día</p>
          </div>
          <div class="flex items-center gap-2 text-xs text-gray-500">
            <span class="material-symbols-outlined text-base text-primary">calendar_today</span>
            7 días · {{ plantilla.dias_comida.count }} comidas
          </div>
          <div class="flex flex-wrap gap-2">
            <a href="{% url 'entrenador_plantilla_nutricion' plantilla.id %}" class="inline-flex items-center gap-1 px-3 py-1 rounded-lg bg-slate-100 text-slate-700 hover:bg-slate-200 text-xs">
              <span class="material-symbols-outlined text-base">edit</span> Editar
            </a>
          </div>
        </article>
        {% empty %}
        <p class="text-sm text-gray-500">Aún no tienes plantillas personalizadas.</p>
        {% endfor %}
      </div>
      <div class="px-6 pb-4">
        <p class="text-xs uppercase tracking-wide text-gray-400 mb-3">Plantillas base</p>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          {% for plantilla in plantillas %}
          <article class="rounded-xl border border-border-light dark:border-border-dark bg-white dark:bg-card-dark p-4 shadow-sm">
            <h3 class="text-sm font-semibold text-gray-900 dark:text-white">{{ plantilla.nombre }}</h3>
            <p class="text-xs text-gray-500">{{ plantilla.descripcion }}</p>
            <p class="text-xs text-gray-500 mt-1">{{ plantilla.objetivo }} kcal/día</p>
          </article>
          {% endfor %}
        </div>
      </div>
    </div>
  </section>

  <section class="bg-white dark:bg-card-dark border border-border-light dark:border-border-dark rounded-2xl shadow-sm overflow-hidden">
    <div class="px-6 py-4 border-b border-border-light dark:border-border-dark flex items-center justify-between">
      <h2 class="text-lg font-semibold">Socios</h2>
      <p class="text-sm text-gray-500">Acciones disponibles por cliente</p>
    </div>
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-border-light dark:divide-border-dark text-sm">
        <thead class="bg-gray-50 dark:bg-card-light">
          <tr>
            <th class="px-6 py-3 text-left font-semibold text-gray-600">Socio</th>
            <th class="px-6 py-3 text-left font-semibold text-gray-600">Plan actual</th>
            <th class="px-6 py-3 text-left font-semibold text-gray-600">Acciones</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-border-light dark:divide-border-dark">
          {% for entry in socios_data %}
          <tr class="bg-white dark:bg-card-dark">
            <td class="px-6 py-4 align-top">
              <p class="font-semibold text-gray-900 dark:text-white">{{ entry.socio.NombreCompleto }}</p>
              <p class="text-xs text-gray-500">{{ entry.socio.Email }}</p>
              {% if entry.comida_preview %}
              <p class="text-xs text-gray-400 mt-2">Hoy: {{ entry.comida_preview|join:", " }}</p>
              {% endif %}
            </td>
            <td class="px-6 py-4 align-top">
              {% if entry.plan %}
                <p class="text-sm text-gray-900 dark:text-white font-semibold">{{ entry.objetivo|default:"-" }} kcal</p>
                <p class="text-xs text-gray-500">Comidas diarias: {{ entry.comidas_por_dia }}</p>
                <div class="mt-2 flex flex-wrap gap-2 text-xs">
                  <a href="{% url 'entrenador_plan_nutricion' entry.socio.id %}" class="inline-flex items-center gap-1 px-3 py-1 rounded-lg bg-blue-600 text-white hover:bg-blue-500">
                    <span class="material-symbols-outlined text-base">edit</span> Ver / editar
                  </a>
                </div>
              {% else %}
                <div class="flex flex-col gap-2">
                  <span class="text-xs font-medium text-red-500">Sin plan asignado</span>
                  <a href="{% url 'entrenador_crear_plan_socio' entry.socio.id %}" class="inline-flex items-center gap-1 text-xs text-primary">
                    <span class="material-symbols-outlined text-base">add</span> Crear plan manual
                  </a>
                </div>
              {% endif %}
            </td>
            <td class="px-6 py-4">
              <form method="post" class="space-y-2">
                {% csrf_token %}
                <input type="hidden" name="socio_id" value="{{ entry.socio.id }}">
                <label class="block">
                  <span class="text-xs font-semibold text-gray-500">Plantilla</span>
                  <select name="plantilla" required class="mt-1 w-full rounded-lg border border-gray-300 dark:border-border-dark bg-white dark:bg-background-dark px-3 py-2 text-sm">
                    <option value="" disabled selected>Selecciona…</option>
                    <optgroup label="Plantillas base">
                      {% for plantilla in plantillas %}
                        <option value="base:{{ plantilla.slug }}">{{ plantilla.nombre }} ({{ plantilla.objetivo }} kcal)</option>
                      {% endfor %}
                    </optgroup>
                    <optgroup label="Mis plantillas">
                      {% for plantilla in plantillas_db %}
                        <option value="db:{{ plantilla.id }}">{{ plantilla.Nombre|default:"Plantilla" }} ({{ plantilla.ObjetivoCaloricoDiario|default:"-" }} kcal)</option>
                      {% endfor %}
                    </optgroup>
                  </select>
                </label>
                <label class="block">
                  <span class="text-xs font-semibold text-gray-500">Objetivo calórico (opcional)</span>
                  <input type="number" name="objetivo_calorico" min="1200" max="4500" step="50" value="{{ entry.objetivo }}" class="mt-1 w-full rounded-lg border border-gray-300 dark:border-border-dark bg-white dark:bg-background-dark px-3 py-2 text-sm" placeholder="Ej. 2100" />
                </label>
                <button type="submit" class="w-full inline-flex items-center justify-center gap-2 rounded-lg bg-primary text-white py-2 text-sm font-semibold hover:bg-primary/90 transition-colors">
                  <span class="material-symbols-outlined text-base">restaurant</span>
                  Asignar / actualizar
                </button>
              </form>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="3" class="px-6 py-6 text-center text-sm text-gray-500">
              No hay socios registrados.
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>
</div>
{% endblock %}
