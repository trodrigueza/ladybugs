{% extends 'base.html' %}

{% block title %}Detalle de Rutina — GluteOS{% endblock %}

{% block content %}
  <div id="rutina-root" data-rutina-id="{{ rutina.id|default:'' }}" class="max-w-6xl mx-auto p-6">
    <div class="flex items-start justify-between gap-4">
      <div>
        <a href="{% url 'rutinas_list' %}" class="inline-flex items-center text-sm text-blue-600 hover:underline">← Volver a lista</a>
        <h1 class="text-3xl font-extrabold mt-4 text-slate-900">{{ rutina.Nombre|default:'(Sin nombre)' }}</h1>
        <p class="text-sm text-gray-600 mt-1">Cliente: <span class="font-medium">{% if rutina.SocioID %}{{ rutina.SocioID.NombreCompleto }}{% else %}Sin asignar{% endif %}</span></p>
        <p class="text-sm text-gray-500">Días: <span class="px-2 py-0.5 ml-1 bg-white/60 rounded-full text-xs font-medium">{{ rutina.DiasEntrenamiento }}</span></p>
      </div>

      <div class="flex items-center gap-3">
        <a href="{% url 'rutinas_list' %}" class="inline-flex items-center gap-2 bg-white shadow-sm px-3 py-2 rounded-md text-sm hover:shadow"> 
          <!-- View icon -->
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-slate-700" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
          Ver todas
        </a>
        <a href="{% url 'editar_rutina_entrenador' rutina_id=rutina.id %}" class="inline-flex items-center gap-2 bg-gray-100 hover:bg-gray-200 text-slate-700 px-3 py-2 rounded-md text-sm shadow-sm">
          <!-- Edit icon -->
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 010 2.828l-9.193 9.193a1 1 0 01-.487.263l-4 1a1 1 0 01-1.213-1.213l1-4a1 1 0 01.263-.487L14.586 2.586a2 2 0 012.828 0z"/></svg>
          Editar
        </a>
        <button id="btn-delete-rutina" class="inline-flex items-center gap-2 bg-red-600 hover:bg-red-500 text-white px-3 py-2 rounded-md text-sm shadow-sm">
          <!-- Trash icon -->
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M6 2a1 1 0 00-1 1v1H3a1 1 0 100 2h14a1 1 0 100-2h-2V3a1 1 0 00-1-1H6zM7 7a1 1 0 012 0v6a1 1 0 11-2 0V7zm4 0a1 1 0 112 0v6a1 1 0 11-2 0V7z"/></svg>
          Eliminar Rutina
        </button>
      </div>
    </div>

    {# CSRF token for AJAX calls #}
    <form id="csrf-form">{% csrf_token %}</form>

    <style>
      /* Ensure numeric inputs show values clearly and remove browser spinners */
      .input-series, .input-reps, .input-peso { height: 2.75rem; padding-left: .75rem; padding-right: .75rem; text-align: center; }
      .input-tempo { height: 2.75rem; padding-left: .75rem; padding-right: .75rem; }
      .input-series::-webkit-outer-spin-button, .input-series::-webkit-inner-spin-button,
      .input-reps::-webkit-outer-spin-button, .input-reps::-webkit-inner-spin-button,
      .input-peso::-webkit-outer-spin-button, .input-peso::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
      .input-series, .input-reps, .input-peso { -moz-appearance: textfield; }
    </style>

    <!-- Toast container -->
    <div id="toast-container" class="fixed right-4 top-6 z-50 space-y-2"></div>

    <!-- Use 2 columns on large screens so day cards are wider and information fits better -->
    <section class="mt-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-6">
      {% for nombre, ejercicios in dias_pares %}
      <details class="group bg-white/80 backdrop-blur-sm border border-gray-200 rounded-lg shadow-sm" open>
        <summary class="flex items-center justify-between p-4 cursor-pointer">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-full bg-gradient-to-r from-indigo-500 to-purple-500 flex items-center justify-center text-white font-semibold">{{ nombre|slice:":1" }}</div>
            <div>
              <div class="text-sm font-semibold text-slate-800">{{ nombre }}</div>
              <div class="text-xs text-gray-500">{{ ejercicios|length }} ejercicio{% if ejercicios|length != 1 %}s{% endif %}</div>
            </div>
          </div>
          <div class="text-gray-400 group-open:rotate-180 transition-transform">▾</div>
        </summary>

        <div class="p-4 border-t border-gray-100">
          {% if ejercicios %}
            <div class="space-y-3">
              {% for e in ejercicios %}
                <div class="flex items-center gap-4 p-3 bg-white rounded-lg shadow-sm overflow-hidden" data-asignacion-id="{{ e.id }}">
                  <div class="flex-shrink-0 w-12 h-12 bg-slate-50 rounded-md flex items-center justify-center text-slate-600 font-medium">{{ forloop.counter }}</div>

                  <div class="flex-1 min-w-0">
                    <div class="flex items-center justify-between">
                      <div class="font-medium text-slate-800">{{ e.EjercicioID.Nombre }}</div>
                      <div class="text-xs text-gray-400">ID #{{ e.id }}</div>
                    </div>

                    <div class="mt-3 grid grid-cols-2 gap-3 md:grid-cols-4 items-center">
                      <div>
                        <label class="text-xs text-gray-500">Series</label>
                        <input type="number" class="input-series block w-full md:w-28 mt-1 rounded-md border border-gray-200 bg-white text-slate-900 px-3 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-200" value="{{ e.Series|default:'' }}">
                      </div>
                      <div>
                        <label class="text-xs text-gray-500">Reps</label>
                        <input type="number" class="input-reps block w-full md:w-28 mt-1 rounded-md border border-gray-200 bg-white text-slate-900 px-3 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-200" value="{{ e.Repeticiones|default:'' }}">
                      </div>
                      <div>
                        <label class="text-xs text-gray-500">Peso</label>
                        <input type="number" step="0.01" class="input-peso block w-full md:w-28 mt-1 rounded-md border border-gray-200 bg-white text-slate-900 px-3 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-200" value="{{ e.PesoObjetivo|default:'' }}">
                      </div>
                      <div>
                        <label class="text-xs text-gray-500">Tempo</label>
                        <input type="text" class="input-tempo block w-full mt-1 rounded-md border border-gray-200 bg-white text-slate-900 px-3 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-200" value="{{ e.Tempo|default:'' }}">
                      </div>
                    </div>

                    <div class="mt-3 flex items-center gap-2">
                      <button class="btn-save inline-flex items-center gap-2 px-3 py-1.5 bg-emerald-600 hover:bg-emerald-500 text-white rounded-md text-sm shadow-sm">
                        <!-- Check icon -->
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 00-1.414-1.414L7 12.172 4.707 9.879a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l9-9z" clip-rule="evenodd"/></svg>
                        Guardar
                      </button>

                      <button class="btn-delete inline-flex items-center gap-2 px-3 py-1.5 bg-red-600 hover:bg-red-500 text-white rounded-md text-sm shadow-sm">
                        <!-- Trash icon -->
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M6 2a1 1 0 00-1 1v1H3a1 1 0 100 2h14a1 1 0 100-2h-2V3a1 1 0 00-1-1H6zM7 7a1 1 0 012 0v6a1 1 0 11-2 0V7zm4 0a1 1 0 112 0v6a1 1 0 11-2 0V7z"/></svg>
                        Eliminar
                      </button>

                      <div class="ml-auto text-sm text-green-600 hidden msg-success">Guardado</div>
                      <div class="ml-auto text-sm text-red-600 hidden msg-error">Error</div>
                    </div>
                  </div>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="text-sm text-gray-400">No hay ejercicios</div>
          {% endif %}
        </div>
      </details>
      {% endfor %}
    </section>

    <script>
      // Read rutina id from data attribute to avoid embedding template tags inside JS
      const RUTINA_ID = (function(){ const el = document.getElementById('rutina-root'); return el && el.dataset && el.dataset.rutinaId ? el.dataset.rutinaId : null; })();

      function getCSRF() { const el = document.querySelector('#csrf-form [name=csrfmiddlewaretoken]'); return el ? el.value : ''; }

      async function postForm(url, data) {
        const res = await fetch(url, {
          method: 'POST',
          headers: {'X-CSRFToken': getCSRF(), 'Content-Type': 'application/x-www-form-urlencoded'},
          body: new URLSearchParams(data).toString()
        });
        return res.json();
      }

      function showToast(message, type='success'){ const container = document.getElementById('toast-container'); const el = document.createElement('div'); el.className = 'max-w-sm w-full bg-white border rounded-md px-4 py-2 shadow flex items-center gap-3'; if (type==='success') el.classList.add('border-emerald-200'); if (type==='error') el.classList.add('border-red-200'); el.innerHTML = `<div class="text-sm text-slate-800">${message}</div>`; container.appendChild(el); setTimeout(()=>{ el.remove(); }, 3500); }

      document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('[data-asignacion-id]').forEach(wrapper => {
          const asignacionId = wrapper.dataset.asignacionId;
          const btnSave = wrapper.querySelector('.btn-save');
          const btnDelete = wrapper.querySelector('.btn-delete');
          const inputSeries = wrapper.querySelector('.input-series');
          const inputReps = wrapper.querySelector('.input-reps');
          const inputPeso = wrapper.querySelector('.input-peso');
          const inputTempo = wrapper.querySelector('.input-tempo');
          const msgSuccess = wrapper.querySelector('.msg-success');
          const msgError = wrapper.querySelector('.msg-error');

          btnSave && btnSave.addEventListener('click', async (ev) => {
            ev.preventDefault();
            msgSuccess && msgSuccess.classList.add('hidden'); msgError && msgError.classList.add('hidden');
            const data = { series: inputSeries ? inputSeries.value : '', reps: inputReps ? inputReps.value : '', peso: inputPeso ? inputPeso.value : '', tempo: inputTempo ? inputTempo.value : '' };
            try {
              const result = await postForm(`/entrenador/asignacion/${asignacionId}/actualizar/`, data);
              if (result.ok) { if (msgSuccess) { msgSuccess.classList.remove('hidden'); setTimeout(()=>msgSuccess.classList.add('hidden'), 2000); } showToast('Guardado correctamente', 'success'); }
              else { if (msgError) { msgError.textContent = result.error || 'Error'; msgError.classList.remove('hidden'); } showToast(result.error || 'Error al guardar', 'error'); }
            } catch (err) { if (msgError) msgError.classList.remove('hidden'); showToast('Error de red', 'error'); }
          });

          btnDelete && btnDelete.addEventListener('click', async (ev) => {
            ev.preventDefault(); if (!confirm('¿Eliminar este ejercicio de la rutina?')) return;
            try { const result = await postForm(`/entrenador/rutina/${RUTINA_ID}/eliminar/`, { id: asignacionId }); if (result.ok) { wrapper.remove(); showToast('Ejercicio eliminado', 'success'); } else { showToast(result.error || 'No se pudo eliminar', 'error'); } } catch (err) { showToast('Error de red', 'error'); }
          });

          // Delete rutina button
          const btnDeleteRutina = document.getElementById('btn-delete-rutina');
          if (btnDeleteRutina) {
            btnDeleteRutina.addEventListener('click', async function (ev) {
              ev.preventDefault();
              if (!confirm('¿Eliminar toda la rutina? Esta acción no se puede deshacer.')) return;
              try {
                const result = await postForm(`/entrenador/rutina/${RUTINA_ID}/borrar/`, {});
                if (result.ok) {
                  // redirigir a la lista
                  window.location.href = '{% url "rutinas_list" %}';
                } else {
                  showToast(result.error || 'No se pudo eliminar la rutina', 'error');
                }
              } catch (err) { showToast('Error de red', 'error'); }
            });
          }
        });
      });
    </script>
  </div>
{% endblock %}
