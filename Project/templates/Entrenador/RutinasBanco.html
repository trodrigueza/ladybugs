{% extends 'base.html' %}

{% block title %}Banco de Rutinas — GluteOS{% endblock %}

{% block content %}
<div class="p-6">
  <div class="flex items-center justify-between mb-6">
    <h1 class="text-2xl font-semibold">Banco de Rutinas</h1>
    <div class="text-sm text-gray-600">Plantillas disponibles: {{ plantillas|length }}</div>
  </div>

  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
    {% for r in plantillas %}
    <div class="bg-white shadow rounded-lg overflow-hidden">
      <div class="p-4 border-b">
        <div class="flex items-start justify-between">
          <div>
            <h2 class="text-lg font-medium">{{ r.Nombre }}</h2>
            <div class="text-sm text-gray-500">Duración: {% if r.DiasEntrenamiento %}{{ r.DiasEntrenamiento }}{% else %}—{% endif %}</div>
          </div>
        </div>
      </div>

      <div class="p-4">
        <div class="text-sm text-gray-700">{% if r.Descripcion %}{{ r.Descripcion }}{% else %}Plantilla de rutina estándar{% endif %}</div>
      </div>

      <div class="p-4 border-t bg-gray-50 flex items-center justify-between">
        <div class="text-sm text-gray-600">ID: {{ r.id }}</div>
        <div class="flex items-center gap-2">
          <button type="button" class="px-3 py-1 text-sm bg-gluteos-blue text-white rounded btn-assign" data-rutina-id="{{ r.id }}">Asignar</button>
          <a href="{% url 'rutina_detalle' r.id %}" class="px-3 py-1 text-sm bg-gray-200 text-gray-700 rounded">Ver detalle</a>
        </div>
      </div>
    </div>
    {% empty %}
    <div class="col-span-full text-center text-gray-500 py-12">No hay plantillas en el banco.</div>
    {% endfor %}
  </div>
</div>

<!-- Modal básico para elegir socio -->
<div id="modal-assign" class="hidden fixed inset-0 bg-black/40 flex items-center justify-center z-50">
  <div class="bg-white rounded-md p-4 w-full max-w-md mx-4">
    <h3 class="text-lg font-semibold mb-2">Asignar plantilla a socio</h3>
    <form id="form-assign" class="space-y-3">
      {% csrf_token %}
      <input type="hidden" name="rutina_id" id="modal-rutina-id" value="">
      <div>
        <label class="text-xs font-medium">Seleccionar cliente</label>
        <select name="socio_id" id="modal-socio" class="w-full mt-1 p-2 border rounded-md" required>
          <option value="">-- Seleccionar cliente --</option>
          {% for s in socios %}<option value="{{ s.id }}">{{ s.NombreCompleto }} ({{ s.Email }})</option>{% endfor %}
        </select>
      </div>
      <div class="flex items-center gap-2 justify-end">
        <button type="button" id="cancel-assign" class="px-3 py-1 rounded-md bg-gray-100">Cancelar</button>
        <button type="submit" class="px-3 py-1 rounded-md bg-gluteos-blue text-white">Asignar</button>
      </div>
    </form>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function(){
  const modal = document.getElementById('modal-assign');
  const form = document.getElementById('form-assign');
  const modalRutina = document.getElementById('modal-rutina-id');
  const modalSocio = document.getElementById('modal-socio');
  const cancel = document.getElementById('cancel-assign');

  function openModal(rutinaId){ modalRutina.value = rutinaId; modalSocio.value = ''; modal.classList.remove('hidden'); }
  function closeModal(){ modal.classList.add('hidden'); }

  document.querySelectorAll('.btn-assign').forEach(btn => {
    btn.addEventListener('click', function(){ openModal(btn.dataset.rutinaId); });
  });

  cancel && cancel.addEventListener('click', function(e){ e.preventDefault(); closeModal(); });

  form && form.addEventListener('submit', async function(e){
    e.preventDefault();
    const rutinaId = modalRutina.value;
    const socioId = modalSocio.value;
    if (!socioId) return alert('Selecciona un cliente');

    try{
      const res = await fetch(`/entrenador/rutina/${rutinaId}/asignar/`, {
        method: 'POST',
        headers: { 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || '', 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({ socio_id: socioId }).toString()
      });
      const data = await res.json();
      if (data.ok) {
        // show temporary message
        const container = document.getElementById('django-messages') || (function(){ const c = document.createElement('div'); c.id='django-messages'; document.body.insertBefore(c, document.body.firstChild); return c; })();
        const el = document.createElement('div'); el.className='p-3 rounded shadow-sm border mb-2 bg-emerald-50 text-emerald-800 border-emerald-200'; el.innerHTML = `<div class="flex items-center justify-between"><div class="flex items-center gap-3"><span class="material-symbols-outlined">check_circle</span><div class="text-sm">Plantilla asignada correctamente</div></div><button class="text-sm text-gray-500 hover:text-gray-700">Cerrar</button></div>`; container.prepend(el);
        closeModal();
      } else {
        alert(data.error || 'No se pudo asignar');
      }
    } catch(err){ alert('Error de red'); }
  });
});
</script>
{% endblock %}
